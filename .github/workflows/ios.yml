name: Input iOS build
on: [push, pull_request]
env:
  QT_VERSION: 5.14.2
  INPUT_SDK_VERSION: 4

jobs:
  mac_os_build:
    if: github.repository == 'lutraconsulting/input'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: download and install input-sdk
        run: |
          DOWNLOAD_DIR=`pwd`
          curl -k -Lo $DOWNLOAD_DIR/input-sdk-${INPUT_SDK_VERSION}.tar.gz "https://www.dropbox.com/s/0hfjybth4zxko7f/input-sdk-ios-${INPUT_SDK_VERSION}.tar.gz?dl=0"
          mkdir -p /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}
          cd /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}
          tar -xvzf $DOWNLOAD_DIR/input-sdk-${INPUT_SDK_VERSION}.tar.gz
          mv /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}/arm64 /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}/stage

      - name: download and install qt
        run: |
          DOWNLOAD_DIR=`pwd`
          curl -k -Lo $DOWNLOAD_DIR/qt-${QT_VERSION}-ios.tar.gz "https://www.dropbox.com/s/whdez6vfckulgxu/qt-${QT_VERSION}-ios.tar.gz?dl=0"
          mkdir -p /opt/Qt/${QT_VERSION}/ios
          cd /opt/Qt/${QT_VERSION}/ios
          tar -xvzf $DOWNLOAD_DIR/qt-${QT_VERSION}-ios.tar.gz

      - name: create build system
        run: |
          INPUT_DIR=`pwd`

          cp scripts/ci/config.pri app/config.pri

          mkdir -p ../build-INPUT
          cd ../build-INPUT

          /opt/Qt/${QT_VERSION}/ios/bin/qmake ${INPUT_DIR}/app/input.pro -spec macx-ios-clang CONFIG+=iphoneos CONFIG+=device && /usr/bin/make qmake_all

      - name: build Input
        run: |
          cd ../build-INPUT
          make -j $(sysctl -n hw.ncpu)
