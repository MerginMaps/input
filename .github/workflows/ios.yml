name: Input iOS build
on: [push, pull_request]
env:
  QT_VERSION: 5.14.2
  INPUT_SDK_VERSION: 4

jobs:
  mac_os_build:
    if: github.repository == 'lutraconsulting/input'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install brew deps
        run: brew install gnupg

      - name: Setup provisioning profile
        env:
          IOS_GPG_KEY: ${{ secrets.IOS_GPG_KEY }}
          IOS_CERT_KEY: ${{ secrets.IOS_CERT_KEY }}
        run: |
          gpg --quiet --batch --yes --decrypt --passphrase="$IOS_GPG_KEY" --output ./.github/secrets/ios/LutraConsultingLtdInputAppStore.mobileprovision ./.github/secrets/ios/LutraConsultingLtdInputAppStore.mobileprovision.gpg
          gpg --quiet --batch --yes --decrypt --passphrase="$IOS_GPG_KEY" --output ./.github/secrets/ios/Certificates_ios_dist.p12 ./.github/secrets/ios/Certificates_ios_dist.p12.gpg
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp ./.github/secrets/ios/LutraConsultingLtdInputAppStore.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/LutraConsultingLtdInputAppStore.mobileprovision
          security create-keychain -p "" build.keychain
          security import ./.github/secrets/ios/Certificates_ios_dist.p12 -t agg -k ~/Library/Keychains/build.keychain -P "$IOS_CERT_KEY" -A
          security list-keychains -s ~/Library/Keychains/build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" ~/Library/Keychains/build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" ~/Library/Keychains/build.keychain

      - name: download and install input-sdk
        run: |
          DOWNLOAD_DIR=`pwd`
          curl -k -Lo $DOWNLOAD_DIR/input-sdk-${INPUT_SDK_VERSION}.tar.gz "https://www.dropbox.com/s/0hfjybth4zxko7f/input-sdk-ios-${INPUT_SDK_VERSION}.tar.gz?dl=0"
          mkdir -p /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}
          cd /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}
          tar -xvzf $DOWNLOAD_DIR/input-sdk-${INPUT_SDK_VERSION}.tar.gz
          mv /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}/arm64 /opt/INPUT/input-sdk-${INPUT_SDK_VERSION}/stage

      - name: download and install qt
        run: |
          DOWNLOAD_DIR=`pwd`
          curl -k -Lo $DOWNLOAD_DIR/qt-${QT_VERSION}-ios.tar.gz "https://www.dropbox.com/s/whdez6vfckulgxu/qt-${QT_VERSION}-ios.tar.gz?dl=0"
          mkdir -p /opt/Qt/${QT_VERSION}/ios
          cd /opt/Qt/${QT_VERSION}/ios
          tar -xvzf $DOWNLOAD_DIR/qt-${QT_VERSION}-ios.tar.gz

      - name: create build system
        run: |
          INPUT_DIR=`pwd`

          cp scripts/ci/config.pri app/config.pri

          mkdir -p ../build-INPUT
          cd ../build-INPUT

          /opt/Qt/${QT_VERSION}/ios/bin/qmake ${INPUT_DIR}/app/input.pro -spec macx-ios-clang CONFIG+=iphoneos CONFIG+=device && /usr/bin/make qmake_all

      - name: build Input
        run: |
          cd ../build-INPUT
          make -j $(sysctl -n hw.ncpu)
